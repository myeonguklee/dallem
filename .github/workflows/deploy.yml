name: Production Deploy

on:
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    env:
      NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
      NEXT_PUBLIC_TEAM_ID: ${{ secrets.NEXT_PUBLIC_TEAM_ID }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Enable Corepack to use pnpm
        run: corepack enable

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
            */*/node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Quick build check
        run: pnpm build

  production-deploy:
    name: Deploy to Production
    needs: health-check
    runs-on: ubuntu-latest
    env:
      NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
      NEXT_PUBLIC_TEAM_ID: ${{ secrets.NEXT_PUBLIC_TEAM_ID }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Enable Corepack to use pnpm
        run: corepack enable

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
            */*/node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Deploy to Vercel Production
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod' # í”„ë¡œë•ì…˜ ë°°í¬

      - name: Create issue on deployment failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' });
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ í”„ë¡œë•ì…˜ ë°°í¬ ì‹¤íŒ¨ - ${date}`,
              body: `## í”„ë¡œë•ì…˜ ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼\n\n**ì‹¤íŒ¨ ì‹œê°„**: ${date}\n**ì‹¤íŒ¨í•œ ì»¤ë°‹**: \`${context.sha.substring(0, 7)}\`\n**ë¸Œëœì¹˜**: \`${context.ref}\`\n\n### ì‹¤íŒ¨í•œ ì›Œí¬í”Œë¡œìš°\n[ì—¬ê¸°ì„œ ë¡œê·¸ í™•ì¸í•˜ê¸°](${runUrl})\n\n### ê¸´ê¸‰ ëŒ€ì‘ ë°©ë²•\n1. ìœ„ì˜ ë§í¬ì—ì„œ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ íŒŒì•…í•˜ì„¸ìš”.\n2. í•„ìš”ì‹œ ì´ì „ ì»¤ë°‹ìœ¼ë¡œ ë¡¤ë°±ì„ ê³ ë ¤í•˜ì„¸ìš”.\n3. ë¬¸ì œë¥¼ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ pushí•˜ì„¸ìš”.\n\n---\n*ì´ ì´ìŠˆëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*`,
              labels: ['deployment-failed', 'production', 'urgent']
            });

      - name: Notify successful deployment
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' });

            console.log(`ğŸ‰ í”„ë¡œë•ì…˜ ë°°í¬ ì„±ê³µ! ${date}`);
            console.log(`ì»¤ë°‹: ${context.sha.substring(0, 7)}`);
            console.log('ë°°í¬ URL: https://moizayo.vercel.app');
